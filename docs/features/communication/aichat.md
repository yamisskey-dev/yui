# AIチャット [[aichat]]

## 概要
- GeminiやOpenAIなどの外部AI APIを利用したチャット機能
- ユーザーの入力に対してAIが自然な応答を生成
- **高度な感情分析システム**と**人間らしい記憶管理**を実装

## 高度な感情分析システム

### 感情分析の仕組み
- **Misskeyカスタム絵文字対応**: `:smile:`, `:heart:`, `:cry:` などの絵文字を感情判定に使用
- **高度なキーワード分析**: 感情に関連する日本語キーワードを詳細に分析
- **文脈分析**: 否定語や強調語を考慮した自然な感情判定

### 感情の種類
```typescript
// 5種類の感情を判定
- happy: 嬉しい、楽しい、幸せ、感動、感謝など
- sad: 悲しい、辛い、苦しい、絶望、後悔など  
- angry: 怒、イライラ、腹立つ、ムカつく、キレるなど
- anxious: 不安、心配、怖い、緊張、焦るなど
- neutral: 上記以外（デフォルト）
```

### 感情分析の特徴
- **否定語処理**: 「ない」「じゃない」があるとポジティブ感情を減らし、ネガティブ感情を増やす
- **強調語処理**: 「すごく」「とても」「めちゃくちゃ」で感情スコアを1.5倍
- **絵文字優先**: 絵文字がある場合は絵文字の感情を優先判定

## 人間らしい記憶管理システム

### 記憶の構造
```typescript
memory: {
  conversations: {
    id: string;
    timestamp: number;
    userMessage: string;
    aiResponse: string;
    context?: string;      // 会話の文脈（感情、話題など）
    importance: number;    // 重要度（0-10）
    isActive: boolean;     // アクティブな記憶かどうか
  }[];
  userProfile?: {
    name: string;
    interests: string[];
    conversationStyle: string;
    lastInteraction: number;
  };
  conversationContext?: {
    currentTopic: string;  // 現在の話題
    mood: string;         // 相手の気分
    relationshipLevel: number; // 親密度
  };
}
```

### 重要度計算システム
- **感情分析結果**: 悲しい・怒っている内容は重要度+3
- **質問**: 質問は重要度+2
- **個人的内容**: 「私」「僕」「俺」「自分」は重要度+2
- **緊急度**: 「急いで」「すぐ」「助けて」は重要度+3
- **メッセージ長**: 50文字以上で+1、100文字以上で+1
- **絵文字使用**: 絵文字1個につき+1（最大+2）
- **強調表現**: 「！」や「すごく」で+1

### 記憶の整理・忘却
- **時間ベース**: 1週間以上前で重要度<6は非アクティブ
- **重要度ベース**: 1日以上前で重要度<4は非アクティブ
- **容量制限**: アクティブな記憶は最大20個まで保持
- **自然な忘却**: 重要度の低い記憶から自動的に非アクティブ化

### 話題分析システム
```typescript
// 10種類の話題を自動判定
- weather: 天気、雨、晴れ、気温など
- work: 仕事、会社、職場、上司など
- hobby: 趣味、ゲーム、映画、音楽など
- family: 家族、親、子供、結婚など
- friends: 友達、恋人、デート、飲み会など
- food: 食べ物、料理、レストラン、お酒など
- technology: パソコン、スマホ、AI、プログラミングなど
- health: 健康、病気、病院、ダイエットなど
- money: お金、貯金、投資、給料など
- education: 学校、勉強、試験、研究など
```

## Geminiへの文脈提供

### 人間らしい文脈生成
```typescript
// 過去の会話を自然な形でGeminiに提供
"adminさんとの過去の会話を参考にしてください。

過去の会話の流れ：
1. [2025/1/19] こんにちは → こんにちは！今日はどうですか？
2. [2025/1/19] 今日はとても嬉しいです！ → それは良かったですね！

現在の話題: work
相手の気分: 嬉しい"
```

## コード定義
- メイン実装: `src/modules/aichat/index.ts`
- APIキーやモデル設定: `config.json`や環境変数

## コードでの扱い方
- `mentionHook`でAIチャットコマンドや通常会話に反応
- 外部API呼び出し・応答生成は非同期で実行
- エラー時は`serifs.ts`のエラーメッセージを利用
- **感情分析**: `analyzeMood()`メソッドで感情を判定
- **記憶管理**: `manageHumanLikeMemory()`メソッドで記憶を更新
- **文脈生成**: `generateHumanLikeContext()`メソッドでGeminiに文脈を提供

## 使い方・拡張方法
- 利用するAIモデルやAPIキーは`config.json`で設定
- 応答パターンやプロンプトのカスタマイズも可能
- 他の会話系機能との連携も容易
- **感情キーワードの追加**: `sentimentKeywords`オブジェクトに新しいキーワードを追加
- **話題キーワードの追加**: `topicKeywords`オブジェクトに新しい話題を追加
- **絵文字感情の追加**: `emojiSentiments`オブジェクトに新しい絵文字を追加

## 関連・連携
- [[features/communication/talk.md]]（通常会話との違い・連携）
- [[features/communication/core.md]]（モジュール管理・基本応答）

## 実装履歴
- **2025/1/19**: 高度な感情分析システム実装
  - Misskeyカスタム絵文字対応
  - 否定語・強調語の文脈分析
  - 人間らしい記憶管理システム
  - 重要度ベースの記憶整理・忘却機能
  - 自然な文脈生成によるGeminiプロンプト改善

---

運用・開発Tipsは [[features/communication/development.md]] を参照。 